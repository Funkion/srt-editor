{"version":3,"sources":["routes/file.js"],"names":[],"mappings":"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","file":"routes/file.js","sourcesContent":["import express from 'express';\nimport async from 'async';\nimport path from 'path';\nimport fs from 'fs';\nimport iconv from 'iconv-lite';\n\nlet router = express.Router();\n\nconst regSubtitleNumber = new RegExp(/^[0-9]+$/);\nconst regSubtitleTime = new RegExp(/^(?:2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9],[0-9][0-9][0-9]\\s-->\\s(?:2[0-3]|[01][0-9]):[0-5][0-9]:[0-5][0-9],[0-9][0-9][0-9]$/);\n\nlet getArr = (str) => {\n\tlet nIndex = 0;\n\tlet nLen = str.length;\n\tlet arr = [];\n\tfor(; nIndex < nLen; nIndex++){\n\t\tarr.push(str.charCodeAt(nIndex));\n\t}\n\treturn arr;\n};\n\nrouter.post('/api/file', (req, res) => {\n\ttry{\n\t\tlet data = req.body;\n\t\tlet buf = new Buffer(data.datafile, 'base64');\n\t\tlet srtString = iconv.decode(buf, \"ISO-8859-1\");\n\t\tlet lines = srtString.split(/\\r\\n|\\r|\\n/g);\n\t\tlet objSrt = {};\n\t\tlet arraySrt = [];\n\t\tfor(let i = 0; i < lines.length; i++){\n\t\t\tif(regSubtitleNumber.test(lines[i])){\n\t\t\t\tobjSrt.subtitleNumber = lines[i];\n\t\t\t}else if(regSubtitleTime.test(lines[i])){\n\t\t\t\tlet times = lines[i].split('-->');\n\t\t\t\tobjSrt.startTime = times[0].trim();\n\t\t\t\tobjSrt.finalTime = times[1].trim();\n\t\t\t}else if(lines[i].length > 0){\n\t\t\t\tif(objSrt.text === undefined){\n\t\t\t\t\tobjSrt.text = lines[i];\n\t\t\t\t}else{\n\t\t\t\t\tlet nextLine = lines[i];\n\t\t\t\t\tobjSrt.text += \"\\n\"+nextLine;\n\t\t\t\t}\n\t\t\t}else{\n\t\t\t\tif(objSrt.subtitleNumber && objSrt.startTime && objSrt.finalTime && objSrt.text){\n\t\t\t\t\tarraySrt.push(objSrt);\n\t\t\t\t}\n\t\t\t\tobjSrt = {};\n\t\t\t}\n\t\t}\n\n\t\treturn res\n\t\t\t.status(200)\n\t\t\t.json({\n\t\t\t\t'subtitles': arraySrt,\n\t\t\t\t'message': 'OK',\n\t\t\t});\n\t}catch(e){\n\t\tconsole.log('Error: '+e.message);\n\t\treturn res\n\t\t\t.status(500)\n\t\t\t.json({\n\t\t\t\t'message': 'Ups! File read error :(',\n\t\t\t});\n\t}\n});\n\nrouter.post('/api/file/makeSrtFile', (req, res) => {\n\tlet data = req.body;\n\tlet pathFile = path.join(__dirname, '..', '..', 'public', 'srt-files', data.inputNameFile);\n\tlet stream;\n\tlet existsFile;\n\tlet buf = new Buffer(data.subtitles, 'base64');\n\tlet srtString = iconv.decode(buf, \"ISO-8859-1\");\n\tlet json = JSON.parse(srtString);\n\tdata.subtitles = json;\n\t//validations\n\tif(!data.inputNameFile || !data.inputEncoding || !data.subtitles){\n\t\treturn res\n\t\t\t.status(401)\n\t\t\t.json({\n\t\t\t\t'message': \"Data doesn't send correctly.\"\n\t\t\t});\n\t}\n\n\tif(!(/^.*\\.(srt|SRT)$/).test(data.inputNameFile)){\n\t\treturn res\n\t\t\t.status(401)\n\t\t\t.json({\n\t\t\t\t'message': \"Incorrect file name.\"\n\t\t\t});\n\t}\n\n\tif(['utf8', 'utf16le', 'ascii'].indexOf(data.inputEncoding) == -1){\n\t\treturn res\n\t\t\t.status(401)\n\t\t\t.json({\n\t\t\t\t'message': \"Incorrect encoding type.\"\n\t\t\t});\n\t}\n\tlet validationError = false;\n\tfor (let i = 0; i < data.subtitles.length; i++){\n\t\tif(!data.subtitles[i].subtitleNumber){\n\t\t\tvalidationError = true;\n\t\t\tbreak;\n\t\t}\n\t\tif(!data.subtitles[i].startTime){\n\t\t\tvalidationError = true;\n\t\t\tbreak;\n\t\t}\n\t\tif(!data.subtitles[i].finalTime){\n\t\t\tvalidationError = true;\n\t\t\tbreak;\n\t\t}\n\t\tif(!data.subtitles[i].text){\n\t\t\tvalidationError = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif(validationError){\n\t\treturn res\n\t\t\t.status(401)\n\t\t\t.json({\n\t\t\t\t'message': \"Subtitles data doesn't send correctly.\"\n\t\t\t});\n\t}\n\n\tlet optionsStream = {\n\t\tencoding: data.inputEncoding\n\t};\n\n\t/*FUNCTIONS*/\n\t\n\tasync.waterfall([\n\t\tfunction checkFileExist(done) {\n\t\t\tfs.exists(pathFile, function (exists){\n\t\t\t\texistsFile = exists;\n\t\t\t\tdone();\n\t\t\t});\n\t\t},\n\t\tfunction deleteIfExist(done) {\n\t\t\tif(existsFile){\n\t\t\t\tfs.unlink(pathFile, done);\n\t\t\t}else{\n\t\t\t\tdone();\n\t\t\t}\n\t\t},\n\t\tfunction writeFile(done) {\n\t\t\tstream = fs.createWriteStream(pathFile, optionsStream);\n\t\t\tstream.once('open', (fd) => {\n\t\t\t\tfor (let i = 0; i < data.subtitles.length; i++){\n\t\t\t\t\tstream.write(data.subtitles[i].subtitleNumber+\"\\n\");\n\t\t\t\t\tstream.write(data.subtitles[i].startTime+\" --> \"+data.subtitles[i].finalTime+\"\\n\");\n\n\t\t\t\t\tlet textSubtitle = data.subtitles[i].text.split(\"\\\\n\");\n\t\t\t\t\tfor(let x = 0; x < textSubtitle.length; x++){\n\t\t\t\t\t\tstream.write(textSubtitle[x]+\"\\n\");\n\t\t\t\t\t}\n\t\t\t\t\tstream.write(\"\\n\");\n\t\t\t\t}\n\t\t\t\tstream.end();\n\t\t\t});\n\n\t\t\tstream.on('finish', () => {\n\t\t\t\tdone();\n\t\t\t});\n\t\t\tstream.on('error', (err) => {\n\t\t\t\tdone(err);\n\t\t\t});\n\t\t}\n\t], (err) => {\n\t\tif(err){\n\t\t\treturn res\n\t\t\t\t.status(500)\n\t\t\t\t.json({\n\t\t\t\t\t'message': \"Ups! An error has ocurred. Details: \"+err.message\n\t\t\t\t});\n\t\t}\n\t\treturn res\n\t\t\t.status(200)\n\t\t\t.json({\n\t\t\t\t'message': \"Yay!\",\n\t\t\t\t\"link\": \"/api/file/download/\"+data.inputNameFile\n\t\t\t});\n\t});\n});\n\nrouter.get(\"/api/file/download/:filename\", (req, res) => {\n\tlet filename = req.params.filename;\n\tif(filename === undefined){\n\t\treturn res.status(404).end();\n\t}else{\n\t\tlet pathFile = path.join(__dirname, '..', '..', 'public', 'srt-files', filename);\n\n\t\tfs.exists(pathFile, (exists) => {\n\t\t\tif(exists){\n\t\t\t\tres.cookie('DownloadFromSRTWebEditor', true, { maxAge: 60000, path: '/' });\n\t\t\t\tres.setHeader('Content-disposition', 'attachment; filename=' + filename);\n\t\t\t\tres.setHeader('Content-type', \"application/x-subrip\");\n\t\t\t\tres.download(pathFile, filename, (err) => {\n\t\t\t\t\tif(err){\n\t\t\t\t\t\treturn res.status(500).end();\n\t\t\t\t\t}\n\t\t\t\t\tfs.unlink(pathFile, (err) => {\n\t\t\t\t\t\tif(err){\n\t\t\t\t\t\t\tconsole.log('Error at delete file. Details: '+err.message);\n\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\tconsole.log('File deleted.');\n\t\t\t\t\t\t}\n\t\t\t\t\t\t\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t}else{\n\t\t\t\treturn res.status(404).end();\n\t\t\t}\n\t\t});\n\t}\n});\n\nexport default router;"],"sourceRoot":"/Users/pabloanabalon/Documents/workspace/srt-editor/es6server"}